version: '2.1'

orbs:
  node: circleci/node@4.2

jobs:
  build:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          cache-path: ~/project/node_modules
          override-ci-command: npm install
      - run: npm run build
      - store_artifacts:
          path: public/

  setup-and-deploy:
    executor: node/default
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - '64:41:f0:77:58:61:05:93:b3:92:81:23:56:33:cc:79'
      - run: git config --global user.email "billy@answeringlegal.com"
      - run: git config --global user.name "answeringLegal"
      - run: ssh-keyscan -H ringsavvy.com >> ~/home/user/.ssh/known_hosts
      - run: git remote add cpanel ssh://ringsavvy@ringsavvy.com:2020/home/ringsavvy/repositories/ringsavvy-website
      - run: git remote -v
      - run: git add public/*
      - run: git commit --allow-empty -m 'CircleCI build deploy'
      - run: git push cpanel main

workflows:
  build-and-deploy:
    jobs:
      - build
      - setup-and-deploy:
          requires:
            - build
          filters:
            branches:
              only: main
